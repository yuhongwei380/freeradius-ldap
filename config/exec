# /etc/freeradius/3.0/mods-available/exec
exec pre_auth_trigger {
    program = "/usr/local/bin/pre_auth_ldap_wrapper.sh"
    wait = yes

    # 【最终修正版】
    # 使用单一的 environment_variables 指令传递所有所需变量
    # %{...} 用于获取 RADIUS 请求属性
    # ${env:...} 用于获取 FreeRADIUS 进程的环境变量 (这些值来自你的 .env 文件)
    environment_variables = "RAD_USERNAME=%{User-Name}, RAD_USER_PASSWORD=%{User-Password}, ldap_server=${env:ldap_server}, ldap_basedn=${env:ldap_basedn}"

    # 其他配置保持不变
    input_pairs = request
    shell_escape = yes
    timeout = 10 
}

exec {
    # wait = yes/no
    # input_pairs = ...
    # program = ...
    # 如果您不打算在这两个阶段做任何特殊事情，可以保持这个块为空或注释掉具体的指令
    # 但这个 "exec { }" 块的存在告诉 FreeRADIUS 有一个名为 "exec" 的模块实例
    # 或者，如果您想让它什么都不做，可以明确写：
    # wait = no
    # input_pairs = none
    # shell_escape = no
    # program = "/bin/true" # 一个总是成功且什么都不做的程序
}
